# Wine_Quality_Preddiction_ECS_Docker

<p>This guide provides a detailed explanation of the process for utilizing AWS services to train a Machine Learning (ML) model on multiple parallel EC2 instances within the Elastic Compute Cloud. The ML program is developed in Python language, incorporating the [Apache Spark MLlib libraries](https://spark.apache.org/mllib/). Both the training and prediction programs are configured to execute within a container.  <br>

[Github link](https://github.com/pavanvenkatreddy/Wine_Quality_Preddiction_ECS_Docker)  <br>
*Docker Image for Training*: [pavanvenkatbhumula/wine:v1](https://hub.docker.com/repository/docker/pavanvenkatbhumula/wine/general)
<br>
*Docker Image for Testing*: [pavanvenkatbhumula/winetest:v1](https://hub.docker.com/repository/docker/pavanvenkatbhumula/winetest/general)

To run the ML Image application for training on multiple parallel EC2 instances, a cluster needs to be set up in ECS. The steps given below are followed to create a cluster with 4 instances.
<br>
<br>In AWS Management Console search for **Elastic Container Service (ECS)**
<br>
  <br>__In ECS Console, select **Cluster** and click on *"Create Cluster"*
  <br>
  <br>__*Cluster name*__ : *winequality* ~your desired name
  <br>
  <br>__*Provisioning model*__ : *On-Demand Instance*
  <br>
  <br>__*EC2 instance type*__ : *t2.micro*
  <br>
  <br>__*Number of instances*__ : *4*
  <br>
  <br>__*Key Pair*__ : *Choose an appropriate key pair*
  <br>
  <br>__*Security group inbound rules (Port range)*__ : *22-80* 
  <br>
<br>- Click on *"Create"*  to create a cluster 
<br>
This can be verified on EC2 dashboard and checking the number of EC2 instances running.
## Setting up Task Definitions and Tasks
We have successfully created a cluster but there is no task running on our instances. In order to run our ML container application we need to create a "Task Definition" which describes information regarding the containers to use, bind mounts, volumes etc. These are done as follows: 
- In **ECS console** select *"Task Definitions"*
- Click on *"Create New task Definition"*
- Choose **Select launch type compatibility** as "EC2"

This will open up **Configure task and container definitions** screen where we have to configure the parameters for our docker conatiner to run correctly. The ML conatiner application used for training outputs 2 files,  *Modelfile*  and *reults.txt*. The *Modelfile* is used in the prediction application and *results.txt* gives metrics of the training model against ValidationDataset.csv. A bind-mount is required between the Docker container and the host to access these files. Do the following configuration 
- __*Task Definition Name*__ : *winequalitytask*
- __*Task Role*__ : *ecsTaskExecutionRole*

The following is done so that the files generated by the docker application is available to the host.
Under __*Volumes*__ click on *"Add volume"* 
- __*Name*__ : *host-path*
- __*Volume type*__ : *Bind Mount*
- __*Source path*__ : */home/ec2-user*

Now we will configure the ML container for training 
Under __*Container Definitions*__ click on *"Add container"* 
- __*Container Name*__ : *winequality*
- __*Image*__ : *pavanvenkatbhumula/winetrain:v1*
- __*Memory Limits*__ : *Soft Limit, 512

Under __*Mount points*__ ,  
- __*Source volume*__ : *host-path*
- __*Container path*__ : */job*
- Click on *"Add"* and then click on *"Create"*

We have successfully created our *"Task Definition"* , now we have create a Task which will initiate our docker container application on the EC2 instances. Do the following to run the task:
- On ECS console click on **Cluster**
- Select the cluster recently created (wine-train-quality-cluster)
- Select **Tasks** tab and click on *"Run new Task"*
- Select **Launch type** as *"EC2"* and select **Number of Task** as *"4"*
- Click on *"Run Task"*

This will download ML conatiner application for training on EC2 instances if not present and starts executing it.
Once the execution is completed two files named *"Modelfile"* and *"results.txt"* should be present in the home directory (/home/ec2-user) of all the running EC2 instances. This *"Modelfile"* can be downloaded from any one these instances which will be used in the prediction application. We can use [Cyberduck](https://cyberduck.io/) to transfer the files to and from ec2 instance.

## Running the Prediction Application on AWS
The ML container for prediction uses 2 files as input  *"Modelfile"*, *"TestDataset.csv"* .
The container application takes the *"TestDataset.csv"* as input and applies the model from *"Modelfile"* and generates a csv file with prediction output. The detailed steps are explained below.

### Installing Docker and downloading the prediction container
In order to run the prediction conatiner docker package is required. To install docker in Amazon linux machine the following steps are done
- Run the following command
```Console
    $ sudo yum install docker -y && sudo systemctl start docker
```
- The docker is pulled with the following command 
```Console
    $ sudo docker pull pavanvenkatbhumula/winetest:v1
```
- Run the following command to verify if the container has been installed
```Console
    $ sudo docker images
```

### Running the docker container 
After installing the image, two files must be present in order to run the container application properly (*Modelfile* and *Inputdataset.csv*). These two files can be uploaded on to the instances using WinSCP. To run the container use the following command
```Console
  $ sudo docker run -v /home/ec2-user:/job pavanvenkatbhumula/winetest:v1 TestDataset.csv
```
where ,
`/home/ec2-user` is the path to the home directory in the instance.
`/job` is the path mapped inside the conatiner
`pavanvenkatbhumula/winetest:v1` is the name of prediction docker image
`TestDataset.csv` is the name of the input file for prediction testing.

*Note: For the above command to work the Modelfile and TestDataset.csv must be present at /home/ec2-user*
